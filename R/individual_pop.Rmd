---
title: "Post-publication review of 'Individual and Population Differences Shape Species Interactions and Natural Selection'"
author: "Sorbus torminalis"
date: "9/11/2020"
output:
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
library(here)
library(tidyverse)
library(broom)
library(patchwork)
theme_set(theme_bw())
```

```{r download}
if(!fs::file_exists(here("data", "intramenvar_data_for_dryad.xlsx"))){
  print("Downloading file")
  filelocation <- rdryad::dryad_download("10.5061/dryad.dc4b0t6")
  fs::file_move(
    path = filelocation[[1]], 
    new_path = here("data", "intramenvar_data_for_dryad.xlsx")
  ) 
}
```

```{r import}
ind_pop <- readxl::read_xlsx(
  path = here("data", "intramenvar_data_for_dryad.xlsx"), 
  sheet = "Sheet1") %>% 
    mutate(mean_treat = factor(mean_treat, levels = c("high", "mid", "low")),
           var_treat = factor(var_treat, levels = c("high", "low")))

```

# Means and variances of the treatments

Table S1, reproduced here for convenience, gives the mean and variance (incorrectly given units of mm rather than mm^2^ throughout the paper) of the gall diameters by treatment.

```{r tableS1}
targets = tribble(~Mean_Treat, ~Var_Treat, ~Mean, ~Variance,
"High",  "High",   25.27, 3.76,  
"High",   "Low", 25.04,   0.55,   
"Medium", "High", 22.01,     3.95,    
"Medium","Low", 22.12, 0.41,
"Low",   "High", 17.99,   4.11,  
"Low",   "Low", 17.88,   0.38)
targets %>% 
  knitr::kable(caption = "Table S1")
```


These statistics match the description of the experimental design

> Population mean gall size spanned from ~18 mm (small) to ~22 mm (medium) to ~25 mm (large). Within-population variance in gall size ranged from ~0.4 to ~4 mm.

but they do not match the mean and variance of the archived data.

```{r table-s1-reproduction}
ind_pop %>% 
  group_by(mean_treat, var_treat) %>% 
  summarise(Mean = mean(gall_size), Variance = var(gall_size)) %>% 
  knitr::kable(caption = "Reproduction of table S1 from the archived data.")
```

None of the entries are an exact match.
Some of the means could be generated by incorrectly rounding the data. 
Several of the variances are very different from that reported. 

The supplementary material also includes histograms of gall diameter by treatment (figs S1-S6). 

```{r figS1-S6-reprod, fig.cap = "Reproduction of figures S1-S6. Mean treatments are arranged left to right, variance treatments vertically"}
ind_pop %>%  
  mutate(mean_treat = fct_rev(mean_treat)) %>% 
  ggplot(aes(x = gall_size)) + 
  geom_histogram(binwidth = 1, center = 0.5) +
  facet_grid(var_treat ~ mean_treat, scales = "free_y")
```

Even though I have tried to match the bin width and centres, none of my histograms exactly match those in the supplementary material, but all are similar enough that, at least for the high variance treatments, gross difference between the reported and actual variance are not expected.

Unless there is an error in my code, either table S1 is incorrect and the treatments do not match what was reported, or the archived data are not the correct data.
In any case, table S1 and figure S5 cannot both be correct.

Please can the author confirm that the correct data are archived, and archive the code needed to reproduce the supplementary material.

Please can the author also please archive the code used for the simulation as the described rejection algorithm will be exceptionally slow for generating samples with a mean far from the population mean.


```{r other_figs, eval = FALSE}
ind_pop %>% 
  ggplot(aes(x = factor(population), y = gall_size, 
             colour = var_treat, shape = mean_treat)) +
  geom_jitter(height = 0)


#fig2a
ind_pop %>% mutate(cause = case_when(
  bird == 1 ~ "2Bird", 
  gig == 1 ~ "3gig", 
  TRUE ~ "1Other")) %>% 
  ggplot(aes(x = gall_size, fill = cause)) + 
  geom_histogram(binwidth = 1, position = "fill") +
  geom_vline(xintercept = c(14.5, 27.5))
  
#fig 3b
ind_pop %>% group_by(mean_treat, var_treat) %>% 
  summarise(mean = mean(gall_size), bird = mean(bird)) %>% 
  ggplot(aes(x = mean, y = bird, shape = var_treat)) + 
  geom_point() +
  ylim(0, NA)

#fig 3c
ind_pop %>% group_by(mean_treat, var_treat) %>% 
  summarise(mean = mean(gall_size), gig = mean(gig)) %>% 
  ggplot(aes(x = mean, y = gig, shape = var_treat)) + 
  geom_point() +
  ylim(0, NA)
```


```{r simulation, eval = FALSE}
ind_pop %>% summarise(m = mean(gall_size), v = var(gall_size), s = sd(gall_size))

replicate(100000, {
  x = rnorm(44, mean = mean(ind_pop$gall_size), sd = sd(ind_pop$gall_size))
  c(mean(x), var(x))
  }) %>% t() %>% 
  as.data.frame() %>% 
  set_names(c("Mean", "Variance")) %>% 
  ggplot(aes(x = Mean, y = Variance)) + 
  geom_point(alpha = 0.3) +
  geom_point(data = targets, colour = "red")
    
#unlikely to match target mean and variance
```

